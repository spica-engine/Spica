<div>
  <mat-toolbar>
    <span>
      <h4 class="mat-h4">
        <ng-content select="[schemaHeader]"> </ng-content>
      </h4>
    </span>
    <div class="actions">
      <ng-content select="[schemaHeaderActions]"> </ng-content>
      <button mat-button (click)="categoryModalMode = 'add'; openCategoryModal(categoryDialog)">
        <mat-icon>add</mat-icon>
        New Category
      </button>
    </div>
  </mat-toolbar>
</div>

<ng-template #categoryDialog>
  <h3>{{ categoryModalMode == "add" ? "Add New" : "Edit" }} Category</h3>
  <mat-divider></mat-divider>
  <mat-form-field>
    <input matInput placeholder="Enter category name..." [(ngModel)]="newCategory" />
  </mat-form-field>
  <div class="actions">
    <button mat-button [disabled]="!newCategory" (click)="categoryAction()">
      <mat-icon> {{ categoryModalMode == "add" ? "add" : "save" }}</mat-icon>
      {{ categoryModalMode == "add" ? "Add new category" : "Save" }}
    </button>
  </div>
</ng-template>

<div class="drag-container">
  <mat-card class="mat-elevation-z25">
    <mat-card-content>
      <ng-content select="[schemaExtraContent]"> </ng-content>
      <div cdkDropList [cdkDropListData]="categories" (cdkDropListDropped)="dropColumn($event)">
        <div
          cdkDrag
          cdkDragLockAxis="y"
          class="drag-part"
          *ngFor="let category of categories; let i = index"
        >
          <mat-accordion class="mat-elevation-z0">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>group_work</mat-icon>
                  <span class="category-name"> {{ category.name }}</span>
                </mat-panel-title>
                <button
                  (click)="
                    $event.stopPropagation();
                    categoryModalMode = 'edit';
                    newCategory = category.name;
                    openCategoryModal(categoryDialog)
                  "
                  mat-icon-button
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  [matAwareDialog]="{
                    title: 'Confirmation',
                    templateOrDescription: deleteCategoryDialog,
                    answer: '',
                    noAnswer: true
                  }"
                  (confirm)="deleteCategory(category.name)"
                  mat-icon-button
                  color="warn"
                  (click)="$event.stopPropagation()"
                >
                  <mat-icon>delete</mat-icon>
                </button>
                <button mat-icon-button cdkDragHandle disableRipple class="drag-button">
                  <mat-icon>drag_handle</mat-icon>
                </button>
              </mat-expansion-panel-header>
              <ng-container
                *ngTemplateOutlet="
                  schemaList;
                  context: {
                    items: categorizedSchemas[category.name],
                    contentId: 'cdk-drop-list-0' + (i + 1)
                  }
                "
              >
              </ng-container>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <div [class.empty-category]="!categorizedSchemas['undefined']?.length">
          <ng-container
            *ngTemplateOutlet="
              schemaList;
              context: {items: categorizedSchemas['undefined'], contentId: 'cdk-drop-list-0100'}
            "
          >
          </ng-container>
        </div>

        <ng-template #schemaList let-contentId="contentId" let-items="items">
          <div
            cdkDropList
            cdkDropListOrientation="vertical"
            (cdkDropListDropped)="drop($event)"
            id="{{ contentId }}"
            [cdkDropListConnectedTo]="dropListIds"
            [cdkDropListData]="items"
          >
            <div cdkDragLockAxis="y" cdkDrag [id]="item._id" *ngFor="let item of items">
              <ng-container *ngTemplateOutlet="itemTemplate; context: {item: item}"> </ng-container>
            </div>
          </div>
        </ng-template>
      </div>
    </mat-card-content>
  </mat-card>
</div>
<ng-template #deleteCategoryDialog let-answer="answer">
  <p>
    This action will remove the category and it will also be removed from those who use the
    category.
  </p>
  <p>
    Please confirm this action to continue.
  </p>
</ng-template>
