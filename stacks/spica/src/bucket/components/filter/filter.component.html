<mat-tab-group
  [(selectedIndex)]="currentTabIndex"
  (selectedTabChange)="reset(); fillHistory()"
  (click)="$event.stopPropagation()"
>
  <mat-tab label="Basic" (click)="$event.stopPropagation()">
    <mat-form-field (click)="$event.stopPropagation()">
      <mat-select
        placeholder="Attribute to Filter"
        [(ngModel)]="property"
        (ngModelChange)="onPropertyChange()"
      >
        <mat-option *ngFor="let propertyKv of properties | keyvalue" [value]="propertyKv.key">
          {{ propertyKv.value.title || propertyKv.key }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <ng-container *ngIf="properties[property]?.type; let type">
      <mat-form-field
        (click)="$event.stopPropagation()"
        class="operator"
        *ngIf="operators.hasOwnProperty(type)"
      >
        <mat-select placeholder="Select an operator" [(ngModel)]="selectedOperator">
          <mat-option
            *ngFor="let operatorKv of operators[type] | keyvalue"
            [value]="operatorKv.value"
          >
            {{
              operatorKv.key
                .replace(operatorKv.key[0], operatorKv.key[0].toUpperCase())
                .replaceAll("_", " ")
            }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-container>
    <span
      *ngIf="property && properties[property].type != 'date'"
      [inputPlacer]="properties[property]"
      [(ngModel)]="value"
      (click)="$event.stopPropagation()"
    ></span>
    <span
      *ngIf="property && properties[property].type == 'date'"
      (click)="$event.stopPropagation()"
    >
      <mat-form-field>
        <mat-label>{{ properties[property].title || properties[property].$name }}</mat-label>
        <input
          matInput
          type="datetime"
          [(ngModel)]="value"
          (focus)="dt1.open()"
          [owlDateTime]="dt1"
          [owlDateTimeTrigger]="dt1"
          placeholder="Date Time"
          selectMode="range"
        />
        <owl-date-time #dt1></owl-date-time>
        <mat-hint *ngIf="schema.description">{{ properties[property].description }}</mat-hint>
      </mat-form-field>
    </span>
  </mat-tab>
  <mat-tab label="MongoDB" (click)="$event.stopPropagation()">
    <div class="tab-content">
      <code-editor
        *ngIf="currentTabIndex == 1"
        placeholder="MongoDB Filter"
        [(ngModel)]="value"
        [options]="{
          minimap: {enabled: false},
          lineNumbers: 'off',
          contextmenu: false,
          value: '{\n\t\n}'
        }"
        language="json"
      >
      </code-editor>
      <div class="history">
        <div class="title"><mat-icon>history</mat-icon><h4>History</h4></div>
        <mat-chip-list>
          <mat-chip
            (click)="value = history"
            [matTooltip]="history"
            *ngFor="let history of mongodbHistory; index as i"
            removable
            (removed)="mongodbHistory.splice(i, 1); saveHistoryChanges('mongodb',mongoHistory)"
          >
            {{ history.length > 10 ? history.slice(0, 10) + ".." : history }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-list>
      </div>
    </div>
  </mat-tab>
  <mat-tab label="Expression" (click)="$event.stopPropagation()">
    <div class="tab-content">
      <code-editor
        *ngIf="currentTabIndex == 2"
        placeholder="Expression Filter"
        [(ngModel)]="value"
        [options]="{minimap: {enabled: false}, lineNumbers: 'off', contextmenu: false, value: ''}"
        language="cel"
        [properties]="properties"
      >
      </code-editor>
      <div class="history">
        <div class="title"><mat-icon>history</mat-icon><h4>History</h4></div>
        <mat-chip-list>
          <mat-chip
            (click)="value = history"
            [matTooltip]="history"
            *ngFor="let history of expressionHistory; index as j"
            removable
            (removed)="expressionHistory.splice(i, 1); saveHistoryChanges('expression',expressionHistory)"
          >
            {{ history.length > 5 ? history.slice(0, 5) + ".." : history }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-list>
      </div>
    </div>
  </mat-tab>
</mat-tab-group>

<div class="filter-buttons">
  <button mat-raised-button (click)="apply()">
    Apply
  </button>
  <button mat-raised-button color="warn" (click)="reset(); filterChange.emit(filter)">
    Clear
  </button>
</div>
